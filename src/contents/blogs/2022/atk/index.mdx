import { GatsbyImage } from "gatsby-plugin-image";

export const frontmatter = {
  type: "blog",
  tag: "atk",
  date: "2022-03-09 17:24",
  title: "ระบบข้อมูล ATK",
  authors: ["myself"],
  excerpt: "การพัฒนาระบบข้อมูล ATK",
  background: "bg.jpg",
  images: [
    "google_form_0.jpg",
    "google_form_1.jpg",
    "google_form_data_1.jpg",
    "atk_analysis_1.jpg",
    "atk_analysis_2.jpg",
    "atk_analysis_3.jpg",
    "app_development_0.jpg",
    "app_development_1.jpg",
    "app_development_2.jpg",
  ]
};

# ที่มาของการพัฒนา

เกิดจากช่วงเดือนกันยายน 2021 ได้มีโครงการที่จะทำการ Surveillance ATK ของเจ้าหน้าที่โรงพยาบาลราชบุรี ทางกลุ่มงานที่ผมทำงานคือกลุ่มงานอาชีวเวชกรรม จึงได้รับหน้าที่ให้มาออกแบบการเฝ้าระวัง
ซึ่งก็ได้จัดกลุ่มความเสี่ยงเป็นสามแบบคือ

- เสี่ยงสูง ตรวจเดือนละ 4 ครั้ง
- เสี่ยงกลาง ตรวจเดือนละ 2 ครั้ง
- เสี่ยงต่ำ ตรวจเดือนละ 1 ครั้ง
  จากนั้นก็ต้องทำระบบรายงานผลการตรวจ ATK ซึ่งในตอนแรกเลือกใช้ Google Form เนื่องจากทำง่าย และได้ข่าวว่าทาง IT จะทำระบบที่มันดีกว่านี้มาแทนอยู่แล้ว

<div className="image-container">
  <GatsbyImage
    image={props.images[0].childImageSharp.gatsbyImageData}
    alt="poster"
  />
  <GatsbyImage
    image={props.images[1].childImageSharp.gatsbyImageData}
    alt="poster"
  />
  <div>ภาพ Google Form ที่ใช้เก็บข้อมูล</div>
</div>

# ปัญหาที่เจอหลังการใช้ Google Form ในการเก็บข้อมูล

เนื่องจาก Google form นั้นไม่สามารถตั้งกฎเกณฑ์ในการ Validate ข้อมูลได้มากนัก เช่น เลขประจำตัว 13 หลัก ผมทำได้แค่ Regular expression ^\d{13}$ แต่ไม่สามารถคำนวนเพื่อตรวจสอบกับเลขหลักหน่วยได้ และไม่สามารถสอบวันที่กรอกได้ ทำให้มีทั้งคนกรอกปี พ.ศ บ้าง คศ. บ้าง หรือวันเกิด มาในช่องวันตรวจ

นอกจากนี้ คนที่กรอกข้อมูลยังต้องกรอกข้อมูลเดิมซ้ำๆ เช่น ชื่อ นามสกุล เลขบัตรประชาชน เบอร์โทรศัพท์ กลุ่มงาน แผนก ที่ทำงาน ทุกครั้งที่ส่งข้อมูลผ่าน Google form ซึ่งก็เพิ่มความลำบากในการกรอก กรอกข้อมูลไม่ตรงกันในแต่ละครั้ง เช่น ชื่อหน่วยงานที่ทำ และกรอกข้อมูลผิด เช่น กรอกเลขบัตรประชาชนบางหลักผิดไป (ตอนนั้นให้กรอก เพราะเพื่อเป็นการเช็คข้อมูลด้วย และไม่สะดวกที่จะมา Merge กับฐานข้อมูลรายชื่อว่าคนนี้เป็นใคร) ทำให้เวลาเอามานับว่าคนนี้ตรวจกี่ครั้งแล้วผิดพลาด เพราะเลขไม่ตรงกัน อีกทั้งเนื่องจากไม่ได้บังคับว่าต้อง Sign in Google Account ก่อน (เพราะบางคนไม่มี และยิ่งยากต่อการกรอก) ทำให้ไม่สามารถแก้ไขได้หลัง submit เกิดการกรอกข้อมูลซ้ำๆ มารัวๆ

<div className="image-container">
  <GatsbyImage
    image={props.images[2].childImageSharp.gatsbyImageData}
    alt="poster"
  />
  <p>ข้อมูลที่ได้จาก Google Form ในรูปของ Google Sheet</p>
</div>

เมื่อจะนำข้อมูลไปวิเคราะห์สถิติเชิงพรรณาว่าแบบแต่ละแผนกตรวจครบหรือไม่ ยังขาดใครจึงต้อง Clean ข้อมูลอย่างยากลำบาก แม้ว่าจะใช้ Pandas ช่วยแล้วก็ตาม ยังมีบางส่วนที่จำเป็นต้อง Clean ด้วยมือ อีกทั้งรายชื่อเจ้าหน้าที่ได้จาก HR ก็ดูเหมือนจะมีจำนวนเจ้าห้นาที่มากกว่าความจริง และไม่ได้รวมพวก Outsource หรือ นักศึกษาแพทย์อย่างครบถ้วน

หลังจากทนมาหลายเดือน ที่วิเคราะห์ข้อมูลอย่างยากลำบาก และยังไม่มีระบบอื่นมาทดแทน Google Form จึงตัดสินใจพัฒนาเองในช่วงปลายเดือนกุมภาพันธ์ 2022

# ปํญหาที่สำคัญคือไม่มีรายชื่อเจ้าหน้าที่ที่ตรวจ ATK ที่ถูกต้อง

ไม่น่าเชื่อว่านี้เป็นปัญหา แต่มันเป็นปัญหา คือ รายชื่อที่ได้จาก HR นั้นจะไม่มีเจ้าหน้าที่ Outsource หรือจ้างเหมา เช่น แม่บ้านเอกชน เจ้าหน้าที่ห้อง CT เป็นต้น และเหมือนมันไม่ได้ Update แบบล่าสุดคือ เหมือนมันยังมีรายชื่อคนที่ไม่ได้อยู่แล้วอยู่ในรายชื่อ ทำให้แผนจากในตอนแรกที่จะเอารายชื่อนี้เป็นฐานข้อมูล เพื่อที่จะได้บอกว่า กลุ่มงานและแผนก นี้มีกี่คน ตรวจกี่คน ครบไหม เป็นไปไม่ได้ ผมจึงต้องเอารายการตอบจาก Google Form ตั้งแต่เดือนกันยายน 2021 - กุมภาพันธ์ 2022 จำนวนประมาณ 14900 ครั้ง มาทำการประมวลผล ซึ่งจะมีปัญหาที่สำคัญ ที่ผมบอกไปคือ ข้อมูลมันกรอกเข้ามาผิด

# การเตรียมข้อมูล
## เตรียมรายชื่อกลุ่มงาน (Department)

หลักการคือผมต้องเตรียม Table ของแต่ละประเภทของ Entity แยกจากกัน และแต่ละ Entity จะมีความสัมพันธ์กันด้วย Primary และ Foreign Key เพื่อที่จะได้สามารถนำข้อมูลเข้าไปยัง Relational database ได้ ดังนั้นผมจะใช้ Pandas ผ่าน Jupyter ในการเตรียมข้อมูล นำเข้าไฟล์ HR โดยใช้ `pd.read_excel("HR.xlsx")` ก่อนจากนั้น `drop_duplicate(subset=[“Department”])` รายชื่อที่ได้จาก HR เพื่อให้ Dataframe เหลือแต่รายชื่อกลุ่มงานที่ไม่ซ้ำกัน แล้วสร้าง Primary Key ด้วย UUID4 แล้วส่งออกข้อมูลเป็น JSON โดยใช่ `pd.to_json("departments.json",orients="records")`

<div className="image-container">
  <GatsbyImage
    image={props.images[7].childImageSharp.gatsbyImageData}
    alt="poster"
  />
  <p>การเตรียมรายชื่อกลุ่มงาน</p>
</div>

## เตรียมรายชื่อแผนก (Division)

ทำแบบเดียวกันนี้กับแผนก โดย `drop_duplicate(subset=[“Department”,”Division”])` เพื่อสร้าง Dataframe ที่มีรายชื่อแผนกที่ไม่ซ้ำกัน แล้วสร้าง Primary Key เช่นเดียวกัน และใช้ `df_divisions.merge(df_departments.rename(columns={"Id":"DepartmentId"}),how="left",on="กลุ่มงาน")` (join วิธีไหนก็ไม่ต่างกันในกรณีนี้) กับ departments เพื่อสร้าง Foreign key (ซึ่งก็คือ DepartmentId) แล้ว `pd.to_json()` เป็น divisions.json

<div className="image-container">
  <GatsbyImage
    image={props.images[8].childImageSharp.gatsbyImageData}
    alt="poster"
  />
  <p>การเตรียมรายชื่อแผนก</p>
</div>

## เตรียมรายชื่อคนตรวจ (Person)

ผมจะยึดข้อมูลที่ตอบมาทาง Google form เป็นหลัก (แปลว่าถ้าใครไม่เคยตอบจะไม่มีชื่อ และผมรายการตอบใน Google form ว่า Entry เพราะการตอบใน Google form 14900 ครั้ง คือการรายงานผล ATK ในแต่ละครั้งซึ่งแน่นอนว่าชื่อคนย่อมต้องซ้ำกัน และคนที่ไม่เคยตอบเลยในช่วง 5 เดือน ก็ถือว่าอาจจะไม่อยู่แล้ว แต่ผมมีระบบ register ภายหลัง) เพราะว่าข้อมูลจาก HR มันไม่มี Outsource และมันยังไม่ได้ตัดคนที่ไปเรียนต่อ ลาออก หรือ ตาย บางส่วนออกไป โดยการทำการ left join ข้อมูลกับไฟล์ HR (เนื่องจากผมเชื่อถือ Personal data จาก HR มากกว่า Google form) โดยเริ่มจาก CitizenID ก่อน เป็น df_people_1 และเอา Entry ที่ไม่ matched มา left join ด้วยชื่อและนามสกุลพร้อมกัน ก็จะได้เป็น df_people_2 แล้วเอาเฉพาะคนที่ matched จากทั้งสอง Dataframe มารวมกัน `pd.concat([df_people_1,df_people_2]).query("_merge=='both'")`